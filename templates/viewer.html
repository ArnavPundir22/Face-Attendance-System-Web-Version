<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Attendance Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- DataTables & Buttons -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
</head>

<body class="bg-gradient-to-br from-slate-100 to-blue-50 min-h-screen font-sans text-gray-800">

  <h1 class="text-4xl font-extrabold text-center text-blue-700 mt-8 mb-4">ğŸ“‹ Attendance Records</h1>

  <!-- Filters -->
  <div class="flex flex-wrap justify-center items-center gap-4 mb-6 px-4">
    <button id="show-today" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded shadow">
      ğŸ“† Show Today's Attendance
    </button>
    <button id="show-all" class="bg-gray-300 hover:bg-gray-400 text-black px-5 py-2 rounded shadow">
      ğŸ“ Show All Records
    </button>
    <select id="status-filter" class="bg-white border border-gray-300 rounded px-4 py-2 shadow">
      <option value="">ğŸ” Filter by Status</option>
      <option value="Present">Present</option>
      <option value="Re-Marked">Re-Marked</option>
    </select>

    <select id="section-filter" class="bg-white border border-gray-300 rounded px-4 py-2 shadow">
      <option value="">ğŸ« Filter by Section</option>
    </select>

    <input type="text" id="lecture-filter" placeholder="Filter by Lecture"
           class="border border-gray-300 rounded px-4 py-2 shadow">

    <button onclick="window.location.href='/'" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded shadow">
      ğŸ•µï¸ Mark Attendance
    </button>
  </div>

  <!-- Email Export -->
  <div class="w-full max-w-4xl mx-auto mt-6 bg-white p-4 rounded-lg shadow flex flex-col md:flex-row gap-4 items-center justify-between">
    <input type="email" id="gmailInput" placeholder="Enter Gmail to send report"
           class="border border-gray-300 rounded px-4 py-2 w-full md:w-auto flex-grow">
    <button id="sendEmailBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded shadow">
      ğŸ“§ Email Report
    </button>
  </div>
  <div id="emailStatus" class="text-center mt-2 text-sm font-semibold text-gray-700"></div>

  <!-- Attendance Table -->
  <div class="w-full flex justify-center px-4 mt-8">
    <div class="overflow-x-auto bg-white p-6 w-full min-h-screen">
      <table id="attendanceTable" class="display nowrap w-full text-sm text-left">
        <thead class="bg-gray-100">
          <tr>
            <th class="text-center">ID</th>
            <th class="text-center">Name</th>
            <th class="text-center">Program</th>
            <th class="text-center">Branch</th>
            <th class="text-center">Mobile</th>
            <th class="text-center">Status</th>
            <th class="text-center">Timestamp</th>
            <th class="text-center">Lecture</th>
            <th class="text-center">Section</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
  let table;
  let timestampColumnIndex = null;
  let statusColumnIndex = null;
  let sectionColumnIndex = null;
  let lectureColumnIndex = null;

  $(document).ready(function () {
    fetch('/get_attendance_data')
      .then(res => res.json())
      .then(data => {
        table = $('#attendanceTable').DataTable({
          data: data,
          scrollX: true,
          dom: 'Bfrtip',
          buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
          columns: Array.from({ length: 9 }, (_, i) => ({ data: i })),
          columnDefs: [
            { className: "text-center", targets: "_all" }
          ],
          createdRow: function (row, rowData) {
            if (statusColumnIndex === null) {
              const headers = $('#attendanceTable thead th')
                .toArray()
                .map(th => $(th).text().trim().toLowerCase());

              statusColumnIndex = headers.indexOf('status');
              timestampColumnIndex = headers.indexOf('timestamp');
              sectionColumnIndex = headers.indexOf('section');
              lectureColumnIndex = headers.indexOf('lecture');
            }

            const status = rowData[statusColumnIndex];
            if (status === 'Re-Marked') {
              $(row).css('background-color', '#FEF9C3'); // Yellow
            } else if (status === 'Present') {
              $(row).css('background-color', '#D1FAE5'); // Green
            }
          }
        });

        // Populate section dropdown with unique values
        if (sectionColumnIndex !== null) {
          const uniqueSections = [...new Set(data.map(row => row[sectionColumnIndex]))].filter(v => v);
          const sectionDropdown = $('#section-filter');
          uniqueSections.forEach(sec => {
            sectionDropdown.append(new Option(sec, sec));
          });
        }
      });

    // Filter by today's date
    $('#show-today').on('click', () => {
      if (timestampColumnIndex !== null) {
        const d = new Date();
        const today = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        table.column(timestampColumnIndex).search('^' + today, true, false).draw();
      }
    });

    // Show all records (reset filters)
    $('#show-all').on('click', () => {
      table.search('').columns().search('').draw();
    });

    // Filter by status
    $('#status-filter').on('change', function () {
      table.column(statusColumnIndex).search(this.value).draw();
    });

    // Filter by section
    $('#section-filter').on('change', function () {
      table.column(sectionColumnIndex).search(this.value).draw();
    });

    // Filter by lecture (on typing)
    $('#lecture-filter').on('keyup', function () {
      table.column(lectureColumnIndex).search(this.value).draw();
    });
  });

  // Email Export Handler
  document.getElementById('sendEmailBtn').addEventListener('click', async () => {
    const email = document.getElementById('gmailInput').value.trim();
    const statusDiv = document.getElementById('emailStatus');

    if (!email || !email.includes('@')) {
      statusDiv.textContent = 'âŒ Please enter a valid Gmail address.';
      statusDiv.classList.add('text-red-600');
      return;
    }

    const tableData = table.rows({ search: 'applied' }).data().toArray();
    if (tableData.length === 0) {
      statusDiv.textContent = 'âš ï¸ No data to send.';
      statusDiv.classList.add('text-red-600');
      return;
    }

    statusDiv.textContent = 'â³ Sending report...';
    statusDiv.classList.remove('text-red-600', 'text-green-600');

    const res = await fetch('/send_attendance_email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, data: tableData })
    });

    const result = await res.json();
    if (result.success) {
      statusDiv.textContent = `âœ… Email sent to ${email}`;
      statusDiv.classList.add('text-green-600');
    } else {
      statusDiv.textContent = `âŒ Failed: ${result.message || 'Something went wrong.'}`;
      statusDiv.classList.add('text-red-600');
    }
  });
</script>

</body>
</html>

