<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Records</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.dataTables.min.css">

  <!-- JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">
  <h1 class="text-3xl font-bold text-center text-purple-600 py-6">ğŸ“‘ Attendance Records</h1>

  <div class="max-w-7xl mx-auto bg-white shadow-lg p-6 rounded-lg overflow-x-auto">
    <button onclick="window.location.href='/'" class="bg-purple-600 text-white px-4 py-2 rounded mb-4">
      â¬… Back
    </button>

    <!-- ğŸ“§ Email Export + Filter Controls -->
    <div class="flex flex-col sm:flex-row gap-2 items-center mb-4">
      <input id="emailInput" type="email" placeholder="Enter email" class="border px-3 py-2 rounded w-full sm:w-1/3">
      <button id="sendEmailBtn" class="bg-green-600 text-white px-4 py-2 rounded">ğŸ“§ Send Report</button>

      <!-- Filter Dropdowns -->
      <select id="statusFilter" class="border px-3 py-2 rounded">
        <option value="">All Status</option>
        <option value="Present">Present</option>
        <option value="Re-Marked">Re-Marked</option>
        <option value="Already Marked">Already Marked</option>
      </select>

      <select id="lectureFilter" class="border px-3 py-2 rounded">
        <option value="">All Lectures</option>
      </select>

      <select id="sectionFilter" class="border px-3 py-2 rounded">
        <option value="">All Sections</option>
      </select>

      <!-- Today's Attendance -->
      <button id="todayBtn" class="bg-blue-600 text-white px-4 py-2 rounded">ğŸ“… Today Only</button>
    </div>

    <table id="attendanceTable" class="display nowrap w-full text-sm">
      <thead>
        <tr>
          <th>Student ID</th>
          <th>Name</th>
          <th>Program</th>
          <th>Branch</th>
          <th>Mobile</th>
          <th>Status</th>
          <th>Timestamp</th>
          <th>Lecture</th>
          <th>Section</th>
        </tr>
      </thead>
    </table>
  </div>

<script>
  let attendanceTable;
  let todayFilterActive = false; // toggle state

  $(document).ready(function () {
    attendanceTable = $('#attendanceTable').DataTable({
      ajax: {
        url: "/get_attendance_data",
        dataSrc: ""
      },
      columns: [
        { data: 0 },
        { data: 1 },
        { data: 2 },
        { data: 3 },
        { data: 4 },
        { data: 5 },
        { data: 6 },
        { data: 7 },
        { data: 8 }
      ],
      responsive: false,
      scrollX: true,
      dom: 'Bfrtip',
      buttons: [
        {
          extend: 'collection',
          text: 'Export â¬‡',
          buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
          className: 'bg-purple-600 text-white px-3 py-1 rounded'
        }
      ],
      initComplete: function () {
        // Populate Lecture & Section filters dynamically
        let lectureSet = new Set();
        let sectionSet = new Set();

        this.api().rows().every(function () {
          let data = this.data();
          lectureSet.add(data[7]);
          sectionSet.add(data[8]);
        });

        lectureSet.forEach(l => $("#lectureFilter").append(`<option value="${l}">${l}</option>`));
        sectionSet.forEach(s => $("#sectionFilter").append(`<option value="${s}">${s}</option>`));
      }
    });

    // ğŸ“§ Send Email
    $("#sendEmailBtn").click(function () {
      const email = $("#emailInput").val().trim();
      if (!email) {
        alert("Please enter an email address.");
        return;
      }

      const data = attendanceTable.rows({ search: 'applied' }).data().toArray();

      $.ajax({
        url: "/send_attendance_email",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify({ email: email, data: data }),
        success: function (res) {
          if (res.success) {
            alert("âœ… Email sent successfully!");
          } else {
            alert("âŒ " + res.message);
          }
        },
        error: function () {
          alert("âŒ Failed to send email.");
        }
      });
    });

    // ğŸ” Filters
    $("#statusFilter").on("change", function () {
      attendanceTable.column(5).search(this.value).draw();
    });

    $("#lectureFilter").on("change", function () {
      attendanceTable.column(7).search(this.value).draw();
    });

    $("#sectionFilter").on("change", function () {
      attendanceTable.column(8).search(this.value).draw();
    });

    // ğŸ“… Today Only (Toggle)
    $("#todayBtn").on("click", function () {
      const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD

      if (!todayFilterActive) {
        // Apply filter
        attendanceTable.column(6).search(today).draw();
        $(this).text("ğŸ“… Show All"); // change button label
        todayFilterActive = true;
      } else {
        // Clear filter
        attendanceTable.column(6).search("").draw();
        $(this).text("ğŸ“… Today Only");
        todayFilterActive = false;
      }
    });
  });
</script>

</body>
</html>

