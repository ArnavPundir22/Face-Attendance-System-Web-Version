<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Face Attendance System</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
        background-color: #0d0d1a;
        color: #e4e4e7;
        background-image: radial-gradient(#2a2a3e 1px, transparent 0);
        background-size: 40px 40px;
    }
    .neon-glow {
        box-shadow: 0 0 5px #a855f7, 0 0 10px #a855f7, 0 0 15px #c084fc;
        transition: all 0.3s ease-in-out;
    }
    .neon-glow:hover {
        box-shadow: 0 0 10px #a855f7, 0 0 20px #a855f7, 0 0 30px #c084fc;
    }
    .dark-card {
        background-color: rgba(32, 32, 50, 0.7);
        backdrop-filter: blur(5px);
        border: 1px solid rgba(168, 85, 247, 0.3);
        border-top: 4px solid #a855f7;
    }
    .input-dark {
        background-color: rgba(13, 13, 26, 0.5);
        border-color: #3b3b55;
        color: #e4e4e7;
    }
    .input-dark:focus {
        border-color: #a855f7;
        box-shadow: 0 0 0 1px #a855f7;
    }
    .result-status-card {
        background-color: rgba(42, 42, 62, 0.7);
        border-left: 4px solid;
    }

    /* ------------------------
          NAVIGATION STYLES
    ------------------------- */
    nav {
        box-shadow: 0 0 10px rgba(168, 85, 247, 0.3);
    }
    .nav-link {
        position: relative;
        padding: 8px 14px;
        border-radius: 8px;
        font-weight: 600;
        color: #c3c3d9;
        transition: all 0.3s ease;
    }
    .nav-link:hover {
        color: #ffffff;
        text-shadow: 0 0 6px #a855f7, 0 0 10px #c084fc;
    }
    .nav-link::after {
        content: "";
        position: absolute;
        left: 50%;
        bottom: -2px;
        width: 0%;
        height: 2px;
        background: linear-gradient(to right, #a855f7, #6366f1);
        border-radius: 4px;
        transition: all 0.3s ease;
        transform: translateX(-50%);
    }
    .nav-link:hover::after {
        width: 80%;
    }
  </style>

</head>

<body class="min-h-screen font-sans flex flex-col">

  <!-- HEADER -->
  <header class="bg-[#121223] shadow-2xl sticky top-0 z-10 border-b border-purple-800">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-extrabold text-white flex items-center gap-2">
        <span class="text-3xl text-purple-400 neon-glow p-1 leading-none">ü§ñ</span> 
        <span class="text-indigo-300">Face Attendance Marker</span>
      </h1>
    </div>

    <!-- UPDATED NAVIGATION BAR -->
    <nav class="flex gap-6 px-6 py-3 bg-[#0d0d1a]/80 backdrop-blur-md border-t border-purple-800 justify-center">
      <a href="/" class="nav-link">Home</a>
      <a href="/viewer" class="nav-link">View Attendance</a>
      <a href="/students" class="nav-link">All Students</a>
      <a href="/add_student" class="nav-link">Add Student</a>
      <a href="/logout" class="nav-link text-red-400 hover:text-red-300">
      Logout
  </a>
    </nav>
  </header>

  <main class="flex-grow flex flex-col items-center px-4 py-10">
    <div class="dark-card rounded-xl shadow-2xl p-8 w-full max-w-2xl">

      <h2 class="text-3xl text-center font-bold text-purple-300 mb-8">
        Mark Attendance with Photo
      </h2>

      <form id="uploadForm" class="space-y-6">

        <!-- Lecture + Section -->
        <div class="grid sm:grid-cols-2 gap-4">
            <div>
                <label class="block text-gray-300 mb-1">Lecture Name</label>
                <input type="text" name="lecture" required class="input-dark w-full rounded-lg px-4 py-2"/>
            </div>
            <div>
                <label class="block text-gray-300 mb-1">Section</label>
                <input type="text" name="section" required class="input-dark w-full rounded-lg px-4 py-2"/>
            </div>
        </div>

        <!-- Gmail -->
        <div>
            <label class="block text-gray-300 mb-1">Send Report To (Gmail)</label>
            <input type="email" id="gmailInput" placeholder="example@gmail.com"
                   class="input-dark w-full rounded-lg px-4 py-2"/>
        </div>

        <!-- File upload -->
        <div class="pt-4 border-t border-[#3b3b55]">
          <label class="block text-gray-300 font-semibold mb-3 text-lg">Upload Images</label>
          <input id="fileInput" type="file" name="images" accept="image/*" multiple
            class="input-dark w-full rounded-lg px-4 py-2"/>
        </div>

        <!-- CAMERA -->
        <div class="mt-6 p-4 bg-indigo-900/30 border border-indigo-700/50 rounded-lg">
            <button type="button" id="openCameraBtn"
                class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold neon-glow">
                üì∑ Open Camera / Webcam
            </button>

            <div id="cameraBox" class="hidden flex flex-col items-center gap-4 pt-4">
              <video id="video" autoplay playsinline
                     class="rounded-lg shadow-2xl border-4 border-purple-500 w-full max-w-full"></video>

              <div class="flex flex-wrap justify-center gap-3 w-full">
                <!-- Manual Snapshot -->
                <button type="button" id="captureBtn"
                        class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg font-semibold">
                  üì∏ Take Snapshot
                </button>

                <!-- Switch Camera -->
                <button type="button" id="switchCameraBtn"
                        class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold">
                  üîÑ Switch Camera
                </button>

                <!-- AUTO CAPTURE -->
                <button type="button" id="autoCaptureBtn"
                        class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold">
                  ü§ñ Auto Capture 5 Photos
                </button>
              </div>

              <canvas id="canvas" class="hidden"></canvas>
            </div>
        </div>

        <!-- Previews -->
        <div id="previewBox"
             class="mt-6 p-3 border border-dashed border-purple-500/50 rounded-lg grid grid-cols-3 gap-3">
          <p class="text-sm text-gray-400 col-span-full text-center">Image Previews will appear here...</p>
        </div>

        <!-- Submit -->
        <button type="submit"
          class="w-full bg-gradient-to-r from-purple-600 to-indigo-500 text-white py-3 rounded-lg font-extrabold neon-glow">
          üì§ EXECUTE SCAN & MARK ATTENDANCE
        </button>
      </form>
    </div>

    <!-- Scan Results -->
    <div id="result" class="w-full max-w-5xl mt-12 space-y-8"></div>

  </main>

<!-- SCRIPT -->
<script>

  /* ------------------------------
        IMAGE PREVIEWS
  ------------------------------- */
  const previewBox = document.getElementById("previewBox");
  document.getElementById("fileInput").addEventListener("change", updatePreviews);

  function updatePreviews(files) {
    previewBox.innerHTML = "";
    files = files.target ? files.target.files : files;

    Array.from(files).forEach(file => {
      const reader = new FileReader();
      reader.onload = ev => {
        const img = document.createElement("img");
        img.src = ev.target.result;
        img.className = "rounded-lg border border-purple-700 h-24 w-full object-cover";
        previewBox.appendChild(img);
      };
      reader.readAsDataURL(file);
    });
  }


  /* ------------------------------
        CAMERA HANDLING
  ------------------------------- */
  let stream = null;
  let usingFrontCamera = true;

  const openCameraBtn = document.getElementById("openCameraBtn");
  const cameraBox = document.getElementById("cameraBox");
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const captureBtn = document.getElementById("captureBtn");
  const switchCameraBtn = document.getElementById("switchCameraBtn");
  const autoCaptureBtn = document.getElementById("autoCaptureBtn");
  const fileInput = document.getElementById("fileInput");

  async function startCamera() {
    if (stream) stream.getTracks().forEach(t => t.stop());

    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: usingFrontCamera ? "user" : "environment" }
    });

    video.srcObject = stream;
  }

  openCameraBtn.addEventListener("click", () => {
    cameraBox.classList.toggle("hidden");

    if (!cameraBox.classList.contains("hidden")) {
      startCamera();
      openCameraBtn.innerHTML = "‚ùå Close Camera";
    } else {
      if (stream) stream.getTracks().forEach(t => t.stop());
      openCameraBtn.innerHTML = "üì∑ Open Camera / Webcam";
    }
  });

  switchCameraBtn.addEventListener("click", () => {
    usingFrontCamera = !usingFrontCamera;
    startCamera();
  });

  /* ------------------------------
       SINGLE SNAPSHOT
  ------------------------------- */
  captureBtn.addEventListener("click", () => {
    captureSinglePhoto();
    alert("üì∏ Snapshot added!");
  });

  function captureSinglePhoto() {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video, 0, 0);

    canvas.toBlob(blob => {
      const file = new File([blob], `capture_${Date.now()}.jpg`, { type: "image/jpeg" });

      const dt = new DataTransfer();
      for (let f of fileInput.files) dt.items.add(f);
      dt.items.add(file);
      fileInput.files = dt.files;

      updatePreviews(fileInput.files);
    });
  }


  /* ------------------------------
       ü§ñ AUTO CAPTURE 5 PHOTOS
  ------------------------------- */
  autoCaptureBtn.addEventListener("click", () => {
    if (!stream) {
        alert("Open the camera first!");
        return;
    }

    autoCaptureBtn.disabled = true;
    autoCaptureBtn.innerHTML = "ü§ñ Capturing...";

    let count = 0;

    const interval = setInterval(() => {
        count++;

        captureSinglePhoto();  // Take photo

        if (count >= 5) {
            clearInterval(interval);

            autoCaptureBtn.disabled = false;
            autoCaptureBtn.innerHTML = "ü§ñ Auto Capture 5 Photos";

            // Auto submit after 1 second
            setTimeout(() => {
                document.querySelector("#uploadForm button[type='submit']").click();
            }, 1000);
        }

    }, 3000); // 3 seconds gap
  });


  /* ------------------------------
        ATTENDANCE SUBMIT
  ------------------------------- */
  const form = document.getElementById("uploadForm");
  const resultBox = document.getElementById("result");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    resultBox.innerHTML = `<div class='text-center p-6 text-yellow-300'>‚öôÔ∏è Processing...</div>`;

    const res = await fetch("/upload_photo", { method: "POST", body: formData });
    const data = await res.json();

    window.currentSessionAttendance = data.session_attendance || [];

    let html = "";
    data.images.forEach((img, idx) => {
      html += `
        <div class="dark-card p-8 rounded-xl">
          <h2 class="text-2xl text-purple-300 mb-6">Scan Report: Image ${idx + 1}</h2>
          <img src="${img.annotated}" class="rounded-lg mb-6 border-2 border-purple-500"/>
          <div class="grid md:grid-cols-2 gap-4">
      `;

      img.results.forEach(r => {
        html += `
          <div class="result-status-card p-4 rounded-lg">
            <p class="font-bold text-lg">${r.name}</p>
            <p>Status: ${r.status}</p>
            <p>Confidence: ${r.confidence}</p>
            ${r.timestamp ? `<p>Time: ${r.timestamp}</p>` : ""}
          </div>
        `;
      });

      html += `</div></div>`;
    });

    html += `
      <div class="flex justify-center mt-8">
        <button id="sendEmailBtn"
            class="bg-purple-600 text-white px-6 py-3 rounded-lg font-bold neon-glow">
            üìß Send Attendance Report to Email
        </button>
      </div>
    `;

    resultBox.innerHTML = html;
  });


  /* ------------------------------
        SEND EMAIL
  ------------------------------- */
  document.addEventListener("click", async (e) => {
    if (e.target.id === "sendEmailBtn") {

      const gmail = document.getElementById("gmailInput").value.trim();
      if (!gmail) return alert("Please enter Gmail.");

      const tableData = window.currentSessionAttendance;
      if (!tableData.length) return alert("No attendance to send for this session.");

      const mailRes = await fetch("/send_attendance_email", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ email: gmail, data: tableData })
      });

      const result = await mailRes.json();
      if (result.success) alert("üì® Email sent!");
      else alert("‚ùå Error: " + result.message);
    }
  });

</script>

</body>
</html>

