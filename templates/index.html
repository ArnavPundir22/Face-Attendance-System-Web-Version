<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Face Attendance System</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-white to-gray-50 min-h-screen font-sans flex flex-col">

  <!-- Header -->
  <header class="bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 shadow-md sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-extrabold text-white tracking-wide flex items-center gap-2">
        <span class="text-3xl">üì∏</span> Face Attendance System
      </h1>

      <!-- Desktop Nav -->
      <nav class="hidden md:flex gap-6">
        <button onclick="window.location.href='/viewer'" class="text-white/80 hover:text-white transition font-medium">Attendance Records</button>
        <button onclick="window.location.href='/add_student'" class="text-white/80 hover:text-white transition font-medium">Add Student</button>
        <button onclick="window.location.href='/students'" class="text-white/80 hover:text-white transition font-medium">View Students</button>
      </nav>

      <!-- Mobile Nav -->
      <div class="md:hidden relative">
        <button id="menuBtn" class="text-white text-2xl">‚ò∞</button>
        <div id="menuBox" class="hidden absolute right-0 mt-2 bg-white rounded-lg shadow-lg text-gray-700 w-40 z-20">
          <button onclick="window.location.href='/viewer'" class="block w-full text-left px-4 py-2 hover:bg-gray-100">Attendance Records</button>
          <button onclick="window.location.href='/add_student'" class="block w-full text-left px-4 py-2 hover:bg-gray-100">Add Student</button>
          <button onclick="window.location.href='/students'" class="block w-full text-left px-4 py-2 hover:bg-gray-100">View Students</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-grow flex flex-col items-center px-4 py-10">
    <div class="bg-white rounded-2xl shadow-lg p-8 w-full max-w-2xl border border-gray-100">
      <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Upload Photos & Mark Attendance</h2>
      <form id="uploadForm" class="space-y-6">

        <!-- Lecture -->
        <div>
          <label class="block text-gray-700 font-medium mb-1">Lecture Name</label>
          <input type="text" name="lecture" required class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-400 focus:outline-none"/>
        </div>

        <!-- Section -->
        <div>
          <label class="block text-gray-700 font-medium mb-1">Section</label>
          <input type="text" name="section" required class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-400 focus:outline-none"/>
        </div>

        <!-- Upload / Camera -->
        <div>
          <label class="block text-gray-700 font-medium mb-1">Upload Photos</label>
          <input id="fileInput" type="file" name="images" accept="image/*" multiple class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-400 focus:outline-none"/>

          <!-- Capture Option -->
          <div class="mt-3 flex flex-col gap-2">
            <button type="button" id="openCameraBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600">
              üì∑ Open Camera
            </button>
            <div id="cameraBox" class="hidden flex flex-col items-center gap-3">
              <video id="video" autoplay playsinline class="rounded-lg border border-gray-300 max-w-full"></video>
              <div class="flex gap-3">
                <button type="button" id="captureBtn" class="bg-green-500 text-white px-4 py-2 rounded-lg shadow hover:bg-green-600">
                  üì∏ Take Snapshot
                </button>
                <button type="button" id="switchCameraBtn" class="bg-purple-500 text-white px-4 py-2 rounded-lg shadow hover:bg-purple-600">
                  üîÑ Switch Camera
                </button>
              </div>
              <canvas id="canvas" class="hidden"></canvas>
            </div>
          </div>

          <!-- Previews -->
          <div id="previewBox" class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-3"></div>
        </div>

        <!-- Submit -->
        <button type="submit" class="w-full bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 text-white py-3 rounded-lg font-semibold hover:opacity-90 shadow-md transition">
          üì§ Upload & Mark Attendance
        </button>
      </form>
    </div>

    <!-- Result -->
    <div id="result" class="w-full max-w-5xl mt-10"></div>
  </main>

  <!-- JS -->
  <script>
    const form = document.getElementById("uploadForm");
    const resultBox = document.getElementById("result");
    const previewBox = document.getElementById("previewBox");

    // Show thumbnails
    function updatePreviews(files) {
      previewBox.innerHTML = "";
      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = document.createElement("img");
          img.src = e.target.result;
          img.className = "rounded-lg border shadow max-h-32 object-cover";
          previewBox.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    }
    document.getElementById("fileInput").addEventListener("change", (e) => updatePreviews(e.target.files));

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      resultBox.innerHTML = "<p class='text-gray-700 font-semibold'>‚è≥ Processing...</p>";
      const formData = new FormData(form);

      const res = await fetch("/upload_photo", { method: "POST", body: formData });
      const data = await res.json();

      if (!data.images.length) {
        resultBox.innerHTML = "<p class='text-red-600 font-semibold'>No faces recognized.</p>";
        return;
      }

      let html = "";
      data.images.forEach((img, idx) => {
        html += `
          <div class="bg-white shadow-lg rounded-xl p-6 border border-gray-100 mb-10">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Annotated Image ${idx + 1}</h2>
            <img src="${img.annotated}" alt="Detected Faces" class="rounded-lg shadow max-w-full mb-6"/>
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Detection Results</h2>
            <div class="grid md:grid-cols-2 gap-4">
        `;
        img.results.forEach(person => {
          const color = person.status === "Unknown" ? "border-red-400 bg-red-50"
                        : person.status === "Already Marked" ? "border-yellow-400 bg-yellow-50"
                        : "border-green-400 bg-green-50";
          html += `
            <div class="p-4 rounded-lg shadow-sm border-l-4 ${color}">
              <p><strong>Name:</strong> ${person.name}</p>
              <p><strong>Status:</strong> ${person.status}</p>
              <p><strong>Confidence:</strong> ${person.confidence}</p>
              ${person.timestamp ? `<p><strong>Time:</strong> ${person.timestamp}</p>` : ''}
            </div>
          `;
        });
        html += "</div></div>";
      });

      resultBox.innerHTML = html;
    });

    // mobile menu
    document.getElementById("menuBtn").addEventListener("click", () => {
      document.getElementById("menuBox").classList.toggle("hidden");
    });

    // Camera functionality
    const openCameraBtn = document.getElementById("openCameraBtn");
    const switchCameraBtn = document.getElementById("switchCameraBtn");
    const cameraBox = document.getElementById("cameraBox");
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const captureBtn = document.getElementById("captureBtn");
    const fileInput = document.getElementById("fileInput");
    let stream;
    let usingFrontCamera = true;

    async function startCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: usingFrontCamera ? "user" : "environment" }
        });
        video.srcObject = stream;
      } catch (err) {
        alert("Camera access denied or not available.");
      }
    }

    openCameraBtn.addEventListener("click", () => {
      cameraBox.classList.toggle("hidden");
      if (!cameraBox.classList.contains("hidden")) {
        startCamera();
      }
    });

    switchCameraBtn.addEventListener("click", () => {
      usingFrontCamera = !usingFrontCamera;
      startCamera();
    });

    captureBtn.addEventListener("click", () => {
      const context = canvas.getContext("2d");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      canvas.toBlob(blob => {
        const file = new File([blob], "captured_photo_" + Date.now() + ".jpg", { type: "image/jpeg" });
        const dataTransfer = new DataTransfer();
        const existingFiles = fileInput.files;
        for (let i = 0; i < existingFiles.length; i++) {
          dataTransfer.items.add(existingFiles[i]);
        }
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;
        updatePreviews(fileInput.files);
        alert("üì∏ Snapshot captured!");
      }, "image/jpeg");
    });
  </script>
</body>
</html>

